(function($){"use strict";var pluginName="formset";var Formset=function(e,t){var n=this;this.opts=$.extend({},Formset.defaults,t);this.$formset=$(e);this.$emptyForm=this.$formset.find(this.opts.emptyForm);this.$body=this.$formset.find(this.opts.body);this.$add=this.$formset.find(this.opts.add);this.formsetPrefix=$(e).data("formset-prefix");this.addForm=$.proxy(this,"addForm");this.$add.click(this.addForm);this.$formset.on("formAdded formDeleted",this.opts.form,$.proxy(this,"checkMaxForms"));this.$forms().each(function(e,t){var r=$(t);n.bindForm($(this),e)});this.$formset.data(pluginName,this);var r=["animateForms"];$.each(r,function(e,t){if(t in n.opts&&n.opts[t]){n[t]()}})};Formset.defaults={form:"[data-formset-form]",emptyForm:"script[type=form-template][data-formset-empty-form]",body:"[data-formset-body]",add:"[data-formset-add]",deleteButton:"[data-formset-delete-button]",hasMaxFormsClass:"has-max-forms",callback:null,animateForms:false};Formset.prototype.addForm=function(){if(this.hasMaxForms()){throw new Error("MAX_NUM_FORMS reached")}var newIndex=this.totalFormCount();this.$managementForm("TOTAL_FORMS").val(newIndex+1);var newFormHtml=this.$emptyForm.html().replace(new RegExp("__prefix__","g"),newIndex).replace(new RegExp("<\\\\/script>","g"),"</script>");var $newFormFragment=$($.parseHTML(newFormHtml,this.$body.document,true));this.$body.append($newFormFragment);var $newForm=$newFormFragment.filter(this.opts.form);this.bindForm($newForm,newIndex);if(this.opts["callback"]!==null){if(this.opts["callback"].indexOf("(")>0){eval(this.opts["callback"])}else{eval(this.opts["callback"]+"()")}}return $newForm};Formset.prototype.bindForm=function(e,t){var n=this.formsetPrefix+"-"+t;e.data(pluginName+"__formPrefix",n);var r=e.find("[name="+n+"-DELETE]");r.change(function(t){if(r.is(":checked")){e.attr("data-formset-form-deleted","");e.trigger("formDeleted")}else{e.removeAttr("data-formset-form-deleted");e.trigger("formAdded")}}).trigger("change");var i=e.find(this.opts.deleteButton);i.bind("click",function(){r.attr("checked",true).change()})};Formset.prototype.$forms=function(){return this.$body.find(this.opts.form)};Formset.prototype.$managementForm=function(e){return this.$formset.find("[name="+this.formsetPrefix+"-"+e+"]")};Formset.prototype.totalFormCount=function(){return this.$forms().length};Formset.prototype.deletedFormCount=function(){return this.$forms().filter("[data-formset-form-deleted]").length};Formset.prototype.activeFormCount=function(){return this.totalFormCount()-this.deletedFormCount()};Formset.prototype.hasMaxForms=function(){var e=parseInt(this.$managementForm("MAX_NUM_FORMS").val(),10)||1e3;return this.activeFormCount()>=e};Formset.prototype.checkMaxForms=function(){if(this.hasMaxForms()){this.$formset.addClass(this.opts.hasMaxFormsClass);this.$add.attr("disabled","disabled")}else{this.$formset.removeClass(this.opts.hasMaxFormsClass);this.$add.removeAttr("disabled")}};Formset.prototype.animateForms=function(){this.$formset.on("formAdded",this.opts.form,function(){var e=$(this);e.slideUp(0);e.slideDown()}).on("formDeleted",this.opts.form,function(){var e=$(this);e.slideUp()});this.$forms().filter("[data-formset-form-deleted]").slideUp(0)};Formset.getOrCreate=function(e,t){var n=$(e).data(pluginName);if(!n){n=new Formset(e,t)}return n};$.fn[pluginName]=function(){var e,t,n;if(arguments.length===0||arguments.length===1&&$.type(arguments[0])!="string"){e=arguments[0];return this.each(function(){return Formset.getOrCreate(this,e)})}t=arguments[0];n=$.makeArray(arguments).slice(1);if(t in Formset){n.unshift(this);return Formset[t].apply(Formset,n)}else{throw new Error("Unknown function call "+t+" for $.fn.formset")}}})(jQuery)